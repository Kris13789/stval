<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Signing you in</title>
    <link rel="stylesheet" href="styles.css" />
  </head>
  <body class="auth-page">
    <div class="app-layout">
      <main class="content">
        <div class="page">
          <header class="page-header auth-status">
            <span class="auth-loader" id="statusLoader" aria-hidden="true"></span>
            <p class="page-subtitle" id="message">Wait a sec...</p>
            <p id="errorMessage" class="empty" hidden></p>
            <a id="backToLogin" href="login.html" class="back-link auth-back-link" hidden>&larr; Back to sign in</a>
          </header>
        </div>
      </main>
    </div>

    <script type="module">
      import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/+esm";

      const SUPABASE_URL = "https://hmmipguhjbklimihatii.supabase.co";
      const SUPABASE_ANON_KEY =
        "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImhtbWlwZ3VoamJrbGltaWhhdGlpIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njk4OTQ4NTAsImV4cCI6MjA4NTQ3MDg1MH0.hpoe40z9M8abumchMFm_5lSDX5kKgpB2UHiaCRixOFY";

      const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
      const statusLoaderEl = document.getElementById("statusLoader");
      const messageEl = document.getElementById("message");
      const errorEl = document.getElementById("errorMessage");
      const backLink = document.getElementById("backToLogin");

      const showError = (message) => {
        statusLoaderEl.hidden = true;
        messageEl.textContent = "Something went wrong";
        messageEl.classList.remove("access-denied-title");
        errorEl.classList.remove("access-denied-note");
        if (message) {
          errorEl.textContent = message;
          errorEl.hidden = false;
        } else {
          errorEl.textContent = "";
          errorEl.hidden = true;
        }
        backLink.hidden = false;
      };

      const readOAuthError = () => {
        const query = new URLSearchParams(window.location.search);
        const hash = new URLSearchParams(window.location.hash.replace(/^#/, ""));
        const error = query.get("error") || hash.get("error");
        const description = query.get("error_description") || hash.get("error_description");
        if (!error) return null;
        return description ? decodeURIComponent(description.replace(/\+/g, " ")) : error;
      };

      const waitForSession = async (attempts = 8, delayMs = 250) => {
        for (let i = 0; i < attempts; i += 1) {
          const {
            data: { session },
          } = await supabase.auth.getSession();
          if (session) return session;
          await new Promise((resolve) => setTimeout(resolve, delayMs));
        }
        return null;
      };

      (async () => {
        const oauthError = readOAuthError();
        if (oauthError) {
          showError(`Sign in failed: ${oauthError}`);
          return;
        }

        const session = await waitForSession();
        if (!session) {
          showError("");
          return;
        }
        const email = session?.user?.email;
        if (!email) {
          showError("Could not get your email.");
          return;
        }
        const { data, error } = await supabase
          .from("allowed_emails")
          .select("email")
          .eq("email", email)
          .maybeSingle();
        if (error || !data) {
          await supabase.auth.signOut();
          statusLoaderEl.hidden = true;
          messageEl.textContent = "Access denied";
          messageEl.classList.add("access-denied-title");
          errorEl.textContent = "Only my husband is allowd to access this shop";
          errorEl.classList.add("access-denied-note");
          errorEl.hidden = false;
          backLink.hidden = false;
          return;
        }
        window.history.replaceState({}, document.title, window.location.pathname);
        window.location.replace("shop.html");
      })();
    </script>
  </body>
</html>
