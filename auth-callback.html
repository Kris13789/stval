<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Signing you in</title>
    <link rel="stylesheet" href="styles.css" />
  </head>
  <body class="shop-page">
    <div class="app-layout">
      <main class="content">
        <div class="page">
          <header class="page-header">
            <h1>Signing you in...</h1>
            <p class="page-subtitle" id="message">Please wait.</p>
            <p id="errorMessage" class="empty" hidden></p>
            <a id="backToLogin" href="login.html" class="menu-link" hidden>Back to sign in</a>
          </header>
        </div>
      </main>
    </div>

    <script type="module">
      import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/+esm";

      const SUPABASE_URL = "https://hmmipguhjbklimihatii.supabase.co";
      const SUPABASE_ANON_KEY =
        "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImhtbWlwZ3VoamJrbGltaWhhdGlpIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njk4OTQ4NTAsImV4cCI6MjA4NTQ3MDg1MH0.hpoe40z9M8abumchMFm_5lSDX5kKgpB2UHiaCRixOFY";

      const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
      const messageEl = document.getElementById("message");
      const errorEl = document.getElementById("errorMessage");
      const backLink = document.getElementById("backToLogin");

      (async () => {
        const { data: { session } } = await supabase.auth.getSession();
        if (!session) {
          messageEl.textContent = "Something went wrong.";
          errorEl.textContent = "Could not sign you in. Please try again.";
          errorEl.hidden = false;
          backLink.hidden = false;
          return;
        }
        const email = session?.user?.email;
        if (!email) {
          messageEl.textContent = "Something went wrong.";
          errorEl.textContent = "Could not get your email.";
          errorEl.hidden = false;
          backLink.hidden = false;
          return;
        }
        const { data, error } = await supabase
          .from("allowed_emails")
          .select("email")
          .eq("email", email)
          .maybeSingle();
        if (error || !data) {
          await supabase.auth.signOut();
          messageEl.textContent = "Access denied.";
          errorEl.textContent = "Your email is not on the list.";
          errorEl.hidden = false;
          backLink.hidden = false;
          return;
        }
        window.location.replace("shop.html");
      })();
    </script>
  </body>
</html>
